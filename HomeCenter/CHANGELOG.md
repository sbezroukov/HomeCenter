# Changelog

## 2026-02-14 (v4)

### Добавлено
- **SQLite Web интерфейс** - веб-интерфейс для просмотра и редактирования базы данных:
  - Автоматически запускается вместе с HomeCenter в Docker
  - Доступен по адресу http://localhost:8050
  - Просмотр всех таблиц и данных
  - Выполнение SQL запросов
  - Редактирование записей
  - Экспорт данных в CSV/JSON/SQL
  - Удобный анализ попыток и статистики

- **Документация** - создан `SQLITE-WEB-GUIDE.md` с:
  - Описанием структуры базы данных
  - Полезными SQL запросами для анализа
  - Примерами редактирования данных
  - Рекомендациями по безопасности

### Улучшено
- **docker-compose.yml** - добавлен сервис `sqlite-web` для удобной работы с БД
- **DOCKER-SETUP.md** - добавлена информация о SQLite Web
- **README.md** - добавлены ссылки на SQLite Web

## 2026-02-14 (v3)

### Добавлено
- **Подробное логирование AI запросов** - для администраторов добавлено детальное логирование:
  - Полный запрос к AI API (URL, модель, заголовки, тело запроса)
  - Полный ответ от AI API (статус, заголовки, тело ответа, время выполнения)
  - Маскировка API ключей (показываются первые 10 символов)
  - Логирование каждого шага обработки попытки
  - Детальная информация об ошибках с типом исключения и stack trace
  - Парсинг и валидация оценок от AI

- **Расширенное логирование фоновой обработки** - `BackgroundGradingService`:
  - Информация о каждой обрабатываемой попытке
  - Детали каждого вопроса и полученной оценки
  - Полная информация об ошибках для администратора
  - Краткое сообщение об ошибке для пользователя

- **Документация** - создан `AI-LOGGING-GUIDE.md` с:
  - Примерами всех типов логов
  - Командами для просмотра и фильтрации логов
  - Диагностикой типичных проблем
  - Рекомендациями по безопасности

### Улучшено
- **Безопасность логирования** - API ключи маскируются в логах (показываются только первые 10 символов)
- **Диагностика ошибок** - администраторы теперь видят полную информацию об ошибках AI запросов
- **Пользовательский опыт** - пользователи видят только краткие сообщения об ошибках

## 2026-02-14 (v2)

### Улучшено
- **Расширенное логирование .env файла** - при запуске приложение показывает:
  - Текущую директорию
  - Путь к `.env` файлу
  - Найден ли файл `.env`
  - Загружены ли переменные из `.env`
  - Статус ключевых переменных (`Admin__Username`, `AI__ApiKey`)

- **Валидация критичных параметров** - приложение проверяет обязательные параметры и выводит **красные ошибки**:
  - ❌ `Admin__Password` не задан
  - ❌ `AI__ApiKey` не задан
  - ❌ `Qwen__ApiKey` не задан (если Qwen включен)
  - ✅ Зеленое подтверждение если все параметры настроены

- **Унифицированный формат .env** - используется формат с двойными подчеркиваниями (`Admin__Password`) для работы как в Docker, так и локально

### Добавлено
- **Копирование .env в Docker** - Dockerfile теперь копирует `.env` файл в образ
- **Документация** - создан `ENV-SETUP-TEST.md` с инструкциями по тестированию и устранению проблем

## 2026-02-14 (v1)

### Исправлено
- **Автообновление меню папок** - после удаления папки или теста меню папок теперь обновляется автоматически без перезагрузки страницы
- **Ошибки сборки** - исправлены проблемы с NuGet (добавлен `nuget.config`) и ссылками на `System.IO.Path` в Razor views

### Добавлено
- **Конфигурация через .env** - все секреты (пароли, API ключи) теперь хранятся в `.env` файле
- **Вывод конфигурации при запуске** - в консоль выводится информация о загруженных настройках (логин админа, AI ключ и т.д.)
- **Система бэкапов для Docker Desktop** - PowerShell скрипты для создания и восстановления бэкапов SQLite базы данных
- **GUI приложение для управления** - Windows Forms приложение `HomeCenterBackup` с возможностями:
  - Создание и восстановление бэкапов
  - Управление Docker контейнером (старт/стоп/рестарт)
  - Различные виды сборки приложения
  - Просмотр логов контейнера
- **Документация** - подробные руководства по Docker, бэкапам и Kubernetes

### Технические детали

#### Автообновление меню папок

**Проблема:** После удаления папки в админке меню не обновлялось, требовалась перезагрузка страницы.

**Решение:**
1. Добавлен новый метод `FolderTree` в `AdminController` для получения обновленного дерева папок
2. Добавлена функция `updateFolderTree()` в JavaScript для обновления дерева через AJAX
3. После удаления папки или теста вызывается `updateFolderTree()` + `loadFolder()`

**Изменённые файлы:**
- `Controllers/AdminController.cs` - добавлен метод `FolderTree`
- `Views/Admin/Index.cshtml` - добавлен ID для дерева папок и функция обновления
- `Views/Admin/_AdminFolderContent.cshtml` - исправлены ссылки на `System.IO.Path`
- `Views/Admin/TestHistory.cshtml` - исправлены ссылки на `System.IO.Path`

#### Конфигурация через .env

**Проблема:** Секреты хранились в `appsettings.Development.json`, который нужно было держать в `.gitignore`.

**Решение:**
1. Добавлен NuGet пакет `DotNetEnv`
2. В `Program.cs` добавлен `DotNetEnv.Env.Load()` для загрузки `.env` файла
3. Все секреты перенесены в `.env.example`
4. `appsettings.Development.json` очищен от секретов и может быть закоммичен

**Изменённые файлы:**
- `HomeCenter.csproj` - добавлен пакет `DotNetEnv`
- `Program.cs` - добавлена загрузка `.env` и вывод конфигурации
- `appsettings.Development.json` - удалены секреты
- `.env.example` - созданы примеры переменных окружения
- `.gitignore` - убран `appsettings.Development.json`, добавлен `.env`

#### NuGet конфигурация

**Проблема:** NuGet пытался скачать пакеты из корпоративного репозитория Qiwi, который требует авторизации.

**Решение:**
- Создан `nuget.config` в корне репозитория для использования только публичного nuget.org

**Область действия:** Только проекты в этом репозитории (HomeCenter и HomeCenterBackup).

### Миграция

Если вы обновляете существующий проект:

1. Создайте `.env` файл:
   ```bash
   cd HomeCenter
   cp .env.example .env
   # Отредактируйте .env и укажите свои значения
   ```

2. Восстановите пакеты:
   ```bash
   dotnet restore
   ```

3. Соберите проект:
   ```bash
   dotnet build
   ```

4. Запустите:
   ```bash
   dotnet run
   ```

5. Проверьте вывод в консоли - должны быть видны загруженные настройки:
   ```
   === Configuration Status ===
   Admin Username: admin
   Admin Password: SET (length: 8)
   AI ApiKey: SET (length: 67, starts with: sk-or-v1-9...)
   ```
