# Обновление приложения в контейнере QuizApp

## Сохранение базы данных (не перезатирается при обновлении)

База данных SQLite хранится в **Docker volume** `quizdb`, который примонтирован к `/app/data` в контейнере. При обновлении контейнера (`docker compose up -d --build`) данные **сохраняются**, так как volume не удаляется.

**Важно:**
- **НЕ выполняйте** `docker compose down -v` — флаг `-v` удаляет volumes, и база будет потеряна.
- Для обычного обновления используйте `docker compose down` (без `-v`) или просто `docker compose up -d --build`.
- Строка подключения к БД задаётся через переменную окружения: `ConnectionStrings__DefaultConnection=Data Source=/app/data/quiz.db`.

При первом запуске приложение создаёт файл `quiz.db` в `/app/data`. После пересборки образа и перезапуска контейнера этот файл остаётся в volume и загружается заново.

---

## Текущая схема

- **Образ:** собирается из `Dockerfile` (multi-stage: SDK → publish → runtime).
- **Контейнер:** `docker-compose.yml` — сервис `quizapp`, порт 8080, образ `quizapp`.
- **Volumes:** `./tests` примонтирована в контейнер — изменения в файлах тестов на хосте сразу видны в контейнере, пересборка не нужна.

Обновлять контейнер нужно только когда меняется **код приложения** (C#, представления, конфиги в образе).

---

## Шаги обновления (код приложения изменился)

Выполнять в каталоге с `docker-compose.yml` (корень QuizApp). Можно использовать скрипт `update-container.ps1` (см. конец раздела).

1. **Остановить и удалить контейнер** (опционально, но удобно для чистого перезапуска):
   ```bash
   docker compose down
   ```

2. **Пересобрать образ и запустить контейнер:**
   ```bash
   docker compose up -d --build
   ```
   - `--build` — принудительная пересборка образа из текущего кода.
   - `-d` — запуск в фоне.

   Либо только пересборка без перезапуска:
   ```bash
   docker compose build --no-cache
   docker compose up -d
   ```
   `--no-cache` полезен, если нужно гарантированно собрать с нуля (без кэша слоёв).

3. **Проверка:** приложение доступно по http://localhost:8080.

---

## Когда пересборка не нужна

- **Только изменились файлы в папке `tests/`** — они смонтированы как volume (`./tests:/app/tests`). Достаточно обновить страницу в браузере или зайти на страницу тестов/админки — список тем подтянется при следующем вызове `SyncTopicsFromFiles()`.

---

## Краткая шпаргалка

| Ситуация                                     | Действие                                                       |
| -------------------------------------------- | -------------------------------------------------------------- |
| Поменялся код (C#, Views, Dockerfile и т.д.) | `docker compose up -d --build` в папке QuizApp                 |
| Поменялись только файлы в `tests/`           | Ничего не делать с контейнером                                 |
| Нужна полная пересборка без кэша             | `docker compose build --no-cache` затем `docker compose up -d`  |

### Скрипт update-container.ps1

В корне QuizApp можно запустить:

- `.\update-container.ps1` — пересборка и запуск (`docker compose up -d --build`).
- `.\update-container.ps1 -Down` — сначала остановить контейнер, затем пересобрать и запустить.
- `.\update-container.ps1 -NoCache` — пересборка без кэша, затем запуск.

---

## Ошибка «read-only file system» при сборке

Сообщение вида `failed to solve: error committing ... read-only file system` означает, что Docker не может записать слой образа при сборке. Частые причины и что сделать:

1. **Мало места на диске**  
   Данные Docker (образы, кэш) обычно лежат на диске с системой (часто C:). Нужно **не менее 10–20 ГБ свободного места**. Освободите место и повторите сборку.

2. **Сборка с сетевого/синхронизируемого каталога**  
   Если проект на сетевом диске, в OneDrive/Google Drive или в папке с ограничениями, сборка может падать. **Скопируйте проект на локальный диск** (например `C:\Projects\QuizApp`) и запускайте `docker compose up -d --build` оттуда.

3. **Сброс Docker Desktop**  
   При «битой» метаданной или кэше:  
   Docker Desktop → Settings (шестерёнка) → **Troubleshoot** → **Clean / Purge data** или **Reset to factory defaults**.  
   После сброса образы и контейнеры удалятся, сборку нужно будет выполнить заново.

4. **Перезапуск Docker**  
   Полностью закройте Docker Desktop и запустите снова, затем снова выполните сборку.
