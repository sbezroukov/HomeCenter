@{
    ViewData["Title"] = "Текстовый редактор тестов";
}

<form id="antiForgeryForm" style="display:none">@Html.AntiForgeryToken()</form>

<h2>Текстовый редактор тестов</h2>

<p class="text-muted">
    Введите текст в формате, описанном в <a asp-controller="Admin" asp-action="ImportFormat" target="_blank">TEST-IMPORT-FORMAT.md</a>.
    Нажмите «Разобрать» для предпросмотра, затем «Создать» для создания файлов.
</p>

<div class="mb-3">
    <label for="importText" class="form-label">Текст для импорта</label>
    <textarea id="importText" class="form-control font-monospace" rows="20" placeholder="===
ФАЙЛ: Папка/имя_теста.txt
MODE: Test

Q: Вопрос?
*1) Правильный
2) Неправильный

===
ФАЙЛ: Папка/Открытые_вопросы.txt
MODE: Open

Q: Открытый вопрос 1?

Q: Открытый вопрос 2?

---

Ответы:
1. Ответ на первый вопрос.
2. Ответ на второй вопрос.

==="></textarea>
</div>

<div class="mb-3">
    <button type="button" class="btn btn-outline-primary" id="btnParse">Разобрать</button>
    <button type="button" class="btn btn-success" id="btnCreate" disabled>Создать</button>
    <a asp-action="Index" class="btn btn-secondary">Назад к админке</a>
</div>

<div id="parseResult" class="card mb-3" style="display: none;">
    <div class="card-header">Предпросмотр</div>
    <div class="card-body">
        <div id="parseErrors" class="alert alert-danger" style="display: none;"></div>
        <div id="parsePreview">
            <p class="text-muted">Будут созданы следующие файлы:</p>
            <ul id="fileList"></ul>
        </div>
    </div>
</div>

<div id="createResult" class="card mb-3" style="display: none;">
    <div class="card-header">Результат создания</div>
    <div class="card-body">
        <div id="createMessage"></div>
        <ul id="createdList" class="mb-0"></ul>
        <ul id="failedList" class="text-danger mb-0"></ul>
    </div>
</div>

@section Scripts {
    <script>
        (function initImportTests() {
            var textarea = document.getElementById('importText');
            var btnParse = document.getElementById('btnParse');
            var btnCreate = document.getElementById('btnCreate');
            var parseResult = document.getElementById('parseResult');
            var parseErrors = document.getElementById('parseErrors');
            var parsePreview = document.getElementById('parsePreview');
            var fileList = document.getElementById('fileList');
            var createResult = document.getElementById('createResult');
            var createMessage = document.getElementById('createMessage');
            var createdList = document.getElementById('createdList');
            var failedList = document.getElementById('failedList');

            var token = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]')?.value;

            btnParse.addEventListener('click', function () {
                var text = textarea.value;
                if (!text.trim()) {
                    parseResult.style.display = 'block';
                    parseErrors.style.display = 'block';
                    parseErrors.textContent = 'Введите текст для разбора.';
                    parsePreview.style.display = 'none';
                    btnCreate.disabled = true;
                    return;
                }

                var formData = new FormData();
                formData.append('importText', text);
                formData.append('__RequestVerificationToken', token);

                fetch('@Url.Action("ParseImportText")', {
                    method: 'POST',
                    body: formData
                })
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    parseResult.style.display = 'block';
                    createResult.style.display = 'none';

                    if (data.errors && data.errors.length > 0) {
                        parseErrors.style.display = 'block';
                        parseErrors.textContent = data.errors.join('\n');
                        parsePreview.style.display = 'none';
                        btnCreate.disabled = true;
                    } else {
                        parseErrors.style.display = 'none';
                        parsePreview.style.display = 'block';
                        fileList.innerHTML = '';
                        if (data.items && data.items.length > 0) {
                            data.items.forEach(function (item) {
                                var li = document.createElement('li');
                                li.textContent = item.path || item.Path;
                                if (item.content || item.Content) {
                                    var pre = document.createElement('pre');
                                    pre.className = 'small bg-light p-2 mt-1 mb-0';
                                    pre.textContent = (item.content || item.Content).substring(0, 200) + (item.content && item.content.length > 200 ? '...' : '');
                                    li.appendChild(pre);
                                }
                                fileList.appendChild(li);
                            });
                            btnCreate.disabled = false;
                        } else {
                            fileList.innerHTML = '<li class="text-muted">Нет блоков для создания</li>';
                            btnCreate.disabled = true;
                        }
                    }
                })
                .catch(function (err) {
                    parseResult.style.display = 'block';
                    parseErrors.style.display = 'block';
                    parseErrors.textContent = 'Ошибка: ' + err.message;
                    btnCreate.disabled = true;
                });
            });

            btnCreate.addEventListener('click', function () {
                var text = textarea.value;
                if (!text.trim()) return;

                var formData = new FormData();
                formData.append('importText', text);
                formData.append('__RequestVerificationToken', token);

                fetch('@Url.Action("CreateFromImportText")', {
                    method: 'POST',
                    body: formData
                })
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    createResult.style.display = 'block';
                    createMessage.textContent = data.message || '';
                    createMessage.className = data.success ? 'alert alert-success' : 'alert alert-warning';

                    createdList.innerHTML = '';
                    failedList.innerHTML = '';
                    if (data.created && data.created.length > 0) {
                        data.created.forEach(function (p) {
                            var li = document.createElement('li');
                            li.textContent = p;
                            createdList.appendChild(li);
                        });
                    }
                    if (data.failed && data.failed.length > 0) {
                        data.failed.forEach(function (p) {
                            var li = document.createElement('li');
                            li.textContent = p;
                            failedList.appendChild(li);
                        });
                    }
                })
                .catch(function (err) {
                    createResult.style.display = 'block';
                    createMessage.textContent = 'Ошибка: ' + err.message;
                    createMessage.className = 'alert alert-danger';
                });
            });
        })();
    </script>
}
