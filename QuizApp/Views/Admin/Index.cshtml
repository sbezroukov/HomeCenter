@model IEnumerable<HomeCenter.Models.Topic>
@using HomeCenter.Models

@{
    ViewData["Title"] = "Админка";
    ViewData["FullWidth"] = true;
    var treeRoot = ViewBag.TreeRoot as TestTreeNode;
    var currentFolder = ViewBag.CurrentFolderPath as string ?? "";
    var includeSubfolders = ViewBag.IncludeSubfolders as bool? ?? true;
    var folderDisplay = ViewBag.FolderDisplay as string ?? "Все темы";
}

<h2>Администрирование тем</h2>

<p>
    Пользователей: @ViewBag.TotalUsers<br />
    Попыток прохождения: @ViewBag.TotalAttempts<br />
    <a asp-action="History" class="btn btn-info btn-sm mt-2">Просмотреть историю всех пользователей</a>
    <a asp-action="ImportTests" class="btn btn-outline-secondary btn-sm mt-2">Текстовый редактор тестов</a>
</p>

<div class="row admin-layout-row">
    <div class="col-md-4 col-lg-3 mb-3 admin-sidebar-col">
        <div class="card shadow-sm admin-sidebar-card">
            <div class="card-body">
                <h2 class="card-title h5 mb-3">Папки</h2>
                <div class="mb-2">
                    <a href="#" class="text-decoration-none js-admin-folder-link @(string.IsNullOrEmpty(currentFolder) ? "fw-semibold" : "")"
                       data-folder="" data-include-subfolders="true">Все темы</a>
                </div>
                @if (treeRoot != null)
                {
                    @await Html.PartialAsync("_AdminFolderTree", (treeRoot, 0, currentFolder))
                }
            </div>
        </div>
    </div>
    <div class="col-md-8 col-lg-9">
        <div class="card shadow-sm">
            <div class="card-body" id="admin-folder-content">
                @await Html.PartialAsync("_AdminFolderContent", Model)
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            var baseUrl = '@Url.Action("Folder", "Admin")';
            var container = document.getElementById('admin-folder-content');

            function loadFolder(folder, includeSubfolders) {
                if (!container) return;
                var url = baseUrl + '?folder=' + encodeURIComponent(folder || '') + '&includeSubfolders=' + (includeSubfolders !== false);
                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(function (r) { return r.text(); })
                    .then(function (html) {
                        container.innerHTML = html;
                        var normFolder = (folder || '').replace(/\\/g, '/');
                        document.querySelectorAll('.js-admin-folder-link').forEach(function (l) {
                            l.classList.remove('fw-semibold', 'active');
                            var lf = (l.getAttribute('data-folder') || '').replace(/\\/g, '/');
                            if (lf === normFolder) {
                                l.classList.add('fw-semibold');
                                if (l.classList.contains('btn')) l.classList.add('active');
                            }
                        });
                    })
                    .catch(function () { location.reload(); });
            }

            document.addEventListener('click', function (e) {
                var link = e.target.closest('.js-admin-folder-link');
                if (link) {
                    e.preventDefault();
                    var folder = link.getAttribute('data-folder') || '';
                    var incl = link.getAttribute('data-include-subfolders') !== 'false';
                    loadFolder(folder, incl);
                }
            });

            document.addEventListener('submit', function (e) {
                var form = e.target.closest('.js-toggle-form');
                if (form) {
                    e.preventDefault();
                    var btn = form.querySelector('button[type="submit"]');
                    var row = form.closest('tr');
                    var statusCell = row ? row.querySelector('.js-access-status') : null;
                    btn.disabled = true;
                    fetch(form.action, { method: 'POST', body: new FormData(form), headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                        .then(function (r) { return r.json(); })
                        .then(function (data) {
                            if (statusCell) {
                                statusCell.textContent = data.isEnabled ? 'Да' : 'Нет';
                                btn.textContent = data.isEnabled ? 'Сделать недоступной' : 'Сделать доступной';
                                btn.className = 'btn btn-sm ' + (data.isEnabled ? 'btn-warning' : 'btn-success');
                            }
                        })
                        .catch(function () { alert('Не удалось изменить доступ.'); })
                        .finally(function () { btn.disabled = false; });
                    return;
                }

                var folderForm = e.target.closest('.js-toggle-folder-form');
                if (folderForm) {
                    e.preventDefault();
                    var btn = folderForm.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    fetch(folderForm.action, { method: 'POST', body: new FormData(folderForm), headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                        .then(function (r) { return r.json(); })
                        .then(function () {
                            var data = container.querySelector('.admin-folder-data');
                            var folder = data ? data.getAttribute('data-current-folder') || '' : '';
                            var incl = data ? data.getAttribute('data-include-subfolders') !== 'false' : true;
                            loadFolder(folder, incl);
                        })
                        .catch(function () { alert('Не удалось изменить доступ.'); })
                        .finally(function () { btn.disabled = false; });
                }
            });
        })();
    </script>
}

<h3>Формат файлов в папке tests</h3>
<pre>
MODE: Test

Q: Сколько будет 2+2?
1) 3
*2) 4
3) 5

Q: Столица Франции?
1) Берлин
2) Мадрид
*3) Париж

------------------------------
MODE: Open

Q: Расскажите, что такое инкапсуляция.

Q: Что такое полиморфизм?

------------------------------
MODE: Self

Q: Опишите алгоритм сортировки вставками.

Q: Перечислите основные структуры данных.
</pre>

