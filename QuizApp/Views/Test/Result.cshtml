@model HomeCenter.Models.TestAttempt
@using System.Text.Json

@functions {
    string? GetJsonString(JsonElement elem, string prop)
    {
        if (!elem.TryGetProperty(prop, out var val)) return null;
        if (val.ValueKind == JsonValueKind.String) return val.GetString();
        if (val.ValueKind == JsonValueKind.Array)
        {
            var parts = val.EnumerateArray().Select(e => e.ValueKind == JsonValueKind.String ? e.GetString() : e.ToString()).Where(s => !string.IsNullOrEmpty(s));
            return string.Join("\n", parts);
        }
        return val.ToString();
    }
}

@{
    ViewData["Title"] = "Результат";
    var details = ViewBag.Details as System.Collections.IEnumerable;
    var topic = Model.Topic;
    var user = Model.User;
}

@if (topic == null)
{
    <p class="text-danger">Тема не найдена.</p>
}
else
{
<h2>Результат по теме "@topic.DisplayPath"</h2>

<div class="card mb-3">
    <div class="card-body">
        <p class="mb-1"><strong>Пользователь:</strong> @(user?.UserName ?? "—")</p>
        <p class="mb-1"><strong>Дата прохождения:</strong> @Model.StartedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</p>
        <p class="mb-1"><strong>Тип теста:</strong> @topic.TypeDisplayName</p>
        <p class="mb-1"><strong>Всего вопросов:</strong> @Model.TotalQuestions</p>
        @if (Model.ScorePercent.HasValue)
        {
            <p class="mb-0">
                <strong>Результат:</strong> 
                <span class="badge @(Model.ScorePercent >= 70 ? "bg-success" : Model.ScorePercent >= 50 ? "bg-warning" : "bg-danger")">
                    @($"{Model.ScorePercent:F2} %")
                </span>
                (@Model.CorrectAnswers из @Model.TotalQuestions правильных)
            </p>
        }
        else
        {
            <p class="mb-0"><strong>Результат:</strong> без автоматической оценки</p>
        }
    </div>
</div>

@if (details != null && details.Cast<object>().Any())
{
    <h3>Детали ответов</h3>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th style="width: 5%">№</th>
                <th style="width: 35%">Вопрос</th>
                @if (topic.Type == HomeCenter.Models.TopicType.Test)
                {
                    <th style="width: 25%">Ваш ответ</th>
                    <th style="width: 25%">Правильный ответ</th>
                    <th style="width: 10%">Статус</th>
                }
                else if (topic.Type == HomeCenter.Models.TopicType.Open)
                {
                    <th style="width: 25%">Ваш ответ</th>
                    <th style="width: 25%">Правильный ответ</th>
                    <th style="width: 5%">Оценка %</th>
                }
                else
                {
                    <th style="width: 55%">Примечание</th>
                }
            </tr>
        </thead>
        <tbody>
            @{
                int questionNum = 1;
                foreach (var detail in details.Cast<object>())
                {
                    var jsonElement = detail as System.Text.Json.JsonElement?;
                    if (jsonElement == null) continue;
                    
                    var elem = jsonElement.Value;
                    <tr>
                        <td>@questionNum</td>
                        <td>@(elem.TryGetProperty("Question", out var qProp) ? qProp.GetString() : "—")</td>
                        
                        @if (topic.Type == HomeCenter.Models.TopicType.Test)
                        {
                            var selected = elem.TryGetProperty("Selected", out var sel) ? sel.GetString() : "Не выбран";
                            var correct = elem.TryGetProperty("Correct", out var cor) ? cor.GetString() : "Не указан";
                            var isCorrect = elem.TryGetProperty("IsCorrect", out var isCor) && isCor.GetBoolean();
                            
                            <td>@selected</td>
                            <td>@correct</td>
                            <td>
                                @if (isCorrect)
                                {
                                    <span class="badge bg-success">✓ Правильно</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">✗ Неправильно</span>
                                }
                            </td>
                        }
                        else if (topic.Type == HomeCenter.Models.TopicType.Open)
                        {
                            var answer = GetJsonString(elem, "Answer") ?? "Нет ответа";
                            var correct = GetJsonString(elem, "Correct");
                            var scorePercent = elem.TryGetProperty("ScorePercent", out var sp) && sp.ValueKind == JsonValueKind.Number ? sp.GetDouble() : (double?)null;
                            <td>
                                @if (string.IsNullOrWhiteSpace(answer))
                                {
                                    <em class="text-muted">Ответ не предоставлен</em>
                                }
                                else
                                {
                                    <div style="white-space: pre-wrap;">@answer</div>
                                }
                            </td>
                            <td>
                                @if (string.IsNullOrEmpty(correct))
                                {
                                    <em class="text-muted">—</em>
                                }
                                else
                                {
                                    <div style="white-space: pre-wrap;">@correct</div>
                                }
                            </td>
                            <td>
                                @if (scorePercent.HasValue)
                                {
                                    <span class="badge @(scorePercent >= 70 ? "bg-success" : scorePercent >= 50 ? "bg-warning" : "bg-danger")">@($"{scorePercent:F0}%")</span>
                                }
                                else
                                {
                                    <em class="text-muted">—</em>
                                }
                            </td>
                        }
                        else
                        {
                            <td><em class="text-muted">Вопрос для самопроверки</em></td>
                        }
                    </tr>
                    questionNum++;
                }
            }
        </tbody>
    </table>
}

@if (User.IsInRole("Admin") && topic != null && topic.Type == HomeCenter.Models.TopicType.Open && details != null && details.Cast<object>().Any())
{
    <hr />
    <h4>Проставить оценки (админ)</h4>
    <form asp-controller="Admin" asp-action="RateAttempt" method="post" class="mb-3">
        <input type="hidden" name="attemptId" value="@Model.Id" />
        @{
            int qi = 0;
            foreach (var detail in details.Cast<object>())
            {
                var jsonElement = detail as System.Text.Json.JsonElement?;
                if (jsonElement == null) continue;
                var elem = jsonElement.Value;
                var curScore = elem.TryGetProperty("ScorePercent", out var sp) && sp.ValueKind == JsonValueKind.Number ? sp.GetDouble() : (double?)null;
                <div class="mb-2">
                    <label class="form-label">Вопрос @(qi + 1): %</label>
                    <input type="number" name="scores[@qi]" value="@(curScore?.ToString("F0") ?? "")" min="0" max="100" step="1" class="form-control form-control-sm" style="width: 80px;" placeholder="0–100" />
                </div>
                qi++;
            }
        }
        <button type="submit" class="btn btn-primary btn-sm">Сохранить оценки</button>
    </form>
}

}
<p>
    <a class="btn btn-primary" asp-controller="Account" asp-action="History">К истории</a>
    <a class="btn btn-secondary" asp-action="Index">К списку тестов</a>
</p>

